---
// 1. MODO EST√ÅTICO
export const prerender = true;

import Layout from '../../layouts/Layout.astro';
import { directus } from '../../lib/directus';
import { readItems } from '@directus/sdk';

// 2. L√ìGICA DE RUTAS (GetStaticPaths)
export async function getStaticPaths() {
  try {
    const projects = await directus.request(readItems('projects', {
      fields: ['slug', 'title', 'image', 'content', 'repo_link', 'url', 'description'],
      filter: { status: { _eq: 'published' } }
    }));

    console.log(`‚úÖ Build Log: ${projects ? projects.length : 0} proyectos encontrados.`);

    if (!Array.isArray(projects)) return [];

    return projects.map((project) => ({
      params: { slug: project.slug },
      props: { project },
    }));

  } catch (error) {
    console.error("üî• Error en Build:", error);
    return [];
  }
}

// 3. RECUPERAR DATOS (Esto debe estar dentro del mismo bloque de guiones ---)
const { project } = Astro.props;

// Redirecci√≥n si no hay proyecto (seguridad)
if (!project) {
  return Astro.redirect('/404');
}

// 4. OPTIMIZACI√ìN DE IM√ÅGENES
// Usamos tu URL de CMS o el fallback directo
const cmsUrl = import.meta.env.PUBLIC_DIRECTUS_URL || 'https://cms.romahomestore.com';

// Construcci√≥n de la URL de imagen optimizada
// NOTA: Si project.image ya viene con la URL completa desde Directus, ajusta esto.
// Normalmente Directus devuelve un ID (ej: "uuid-foto").
const imageUrl = project.image 
  ? `${cmsUrl}/assets/${project.image}?format=webp&width=1200&quality=80` 
  : null;
---

<Layout title={project.title} description={project.description}>
  <main class="w-full max-w-4xl mx-auto p-4 text-white pb-20 mt-10">
    
    <header class="mb-12 text-center">
      <h1 class="text-4xl font-bold mb-6 text-blue-400">{project.title}</h1>
      
      {imageUrl && (
        <img 
          src={imageUrl} 
          alt={project.title} 
          fetchpriority="high"
          loading="eager"
          class="w-full max-h-[500px] object-cover rounded-3xl border border-neutral-800 shadow-2xl mb-8"
          transition:name={`image-${project.slug}`} 
        />
      )}
    </header>

    <article class="prose prose-invert prose-lg max-w-none prose-headings:text-blue-400 prose-a:text-purple-400 prose-img:rounded-2xl">
      <div set:html={project.content} />
    </article>

    <div class="flex gap-4 mt-8 justify-center">
        {project.repo_link && (
            <a href={project.repo_link} target="_blank" rel="noopener noreferrer" class="px-6 py-2 bg-neutral-800 rounded-full hover:bg-neutral-700 transition">GitHub</a>
        )}
        {project.url && (
            <a href={project.url} target="_blank" rel="noopener noreferrer" class="px-6 py-2 bg-blue-600 rounded-full hover:bg-blue-500 transition">Ver Demo</a>
        )}
    </div>

  </main>
</Layout>