---
// 1. IMPORTANTE: Eliminamos "export const prerender = true"
// Al quitarlo (y como ya configuramos 'output: server' en el config), 
// esta página se volverá 100% dinámica (SSR).

import Layout from '../../layouts/Layout.astro';
import { directus } from '../../lib/directus';
import { readItems } from '@directus/sdk';

// 2. Obtenemos el "slug" directamente de la URL del navegador
const { slug } = Astro.params;

let project;

try {
  // 3. Buscamos en Directus el proyecto que coincida con este slug
  const result = await directus.request(readItems('projects', {
    filter: {
      slug: { _eq: slug },
      status: { _eq: 'published' }
    },
    fields: ['slug', 'title', 'image', 'content', 'repo_link', 'url', 'description'],
    limit: 1
  }));

  // Directus devuelve un array, tomamos el primero
  project = result[0];

} catch (error) {
  console.error("Error buscando proyecto:", error);
}

// 4. Si no existe el proyecto en la DB, mandamos al usuario al 404
if (!project) {
  return Astro.redirect('/404');
}

// Configuración de imagen
const cmsUrl = import.meta.env.PUBLIC_DIRECTUS_URL || 'https://cms.romahomestore.com';
const imageUrl = project.image 
  ? `${cmsUrl}/assets/${project.image}` 
  : null;
---

<Layout title={project.title} description={project.description}>
  <main class="w-full max-w-4xl mx-auto p-4 text-white pb-20 mt-10">
    
    <a href="/" class="group inline-flex items-center gap-2 text-gray-400 hover:text-white mb-8 transition-colors">
      <span class="group-hover:-translate-x-1 transition-transform">←</span> Back to Portfolio
    </a>

    <header class="mb-12 text-center">
      <div class="inline-block px-3 py-1 mb-4 text-xs font-mono text-blue-400 border border-blue-900/50 rounded-full bg-blue-900/20">
        Project Case Study
      </div>
      
      <h1 class="text-4xl md:text-6xl font-black mb-6 leading-tight text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">
        {project.title}
      </h1>
      
      {imageUrl && (
        <img 
          src={imageUrl} 
          alt={project.title} 
          class="w-full max-h-[500px] object-cover rounded-3xl border border-neutral-800 shadow-2xl mb-8"
          transition:name={`image-${project.slug}`} 
        />
      )}

      <div class="flex flex-wrap justify-center gap-4">
        {project.repo_link && (
          <a href={project.repo_link} target="_blank" class="px-6 py-2 bg-neutral-800 border border-neutral-700 rounded-full hover:bg-neutral-700 transition-colors flex items-center gap-2 text-sm font-bold">
            View Code
          </a>
        )}
        {project.url && (
          <a href={project.url} target="_blank" class="px-6 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-500 transition-colors flex items-center gap-2 text-sm font-bold shadow-lg shadow-blue-900/20">
            Live Demo ↗
          </a>
        )}
      </div>
    </header>

    <article class="prose prose-invert prose-lg max-w-none prose-headings:text-blue-400 prose-a:text-purple-400 prose-img:rounded-2xl">
      <div set:html={project.content} />
    </article>

  </main>
</Layout>